<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Raspadinha Digital</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #ffd700;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        text-align: center;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        width: 100%;
        max-width: 500px;
      }

      .scratch-card {
        position: relative;
        width: 100%;
        height: 150px;
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease-in-out;
      }

      .scratch-card:hover {
        transform: scale(1.02);
      }

      canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .message {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        font-weight: bold;
        color: #333;
        text-align: center;
      }

      .message img {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin-bottom: 10px;
      }

      #submitButton {
        margin-top: 20px;
        padding: 12px 24px;
        font-size: 18px;
        font-weight: bold;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      #submitButton:hover {
        background-color: #555;
      }

      #submitButton:disabled {
        background-color: #999;
        cursor: not-allowed;
      }

      .alert {
        background-color: #ff3333;
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        width: 90%;
        max-width: 400px;
      }

      .scratch-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #d3d3d3 25%, #b8b8b8 25%, #b8b8b8 50%, #d3d3d3 50%, #d3d3d3 75%, #b8b8b8 75%);
        background-size: 20px 20px;
        z-index: 1;
      }

      .scratch-text {
        position: absolute;
        bottom: 10px;
        left: 0;
        width: 100%;
        text-align: center;
        color: #333;
        font-size: 14px;
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <div class="alert">
      ‚ö†Ô∏è Tentar atualizar para trocar de pr√™mio n√£o ir√° funcionar!
    </div>
    <div id="titulo">
      <h1>üéâ Raspadinha Riach√£o üéâ</h1>
      <p>Raspe <strong>1 das 3 op√ß√µes</strong> e veja seu pr√™mio!</p>
    </div>
    <div class="container" id="scratchContainer"></div>
    <button id="submitButton" onclick="enviarResultado()" disabled>
      Enviar Resultado
    </button>

    <script>
      // Mapeamento de pr√™mios para imagens
      const prizeImages = {
        "üöó Carro": "imgs/carro.png",
        "üèçÔ∏è Moto": "imgs/moto.png",
        "üì∫ TV": "imgs/tv.png",
      };

      const prizes = Object.keys(prizeImages);
      const selectedPrizes = prizes.sort(() => 0.5 - Math.random()).slice(0, 3);
      const scratchContainer = document.getElementById("scratchContainer");
      const submitButton = document.getElementById("submitButton");
      
      let selectedCard = localStorage.getItem("raspadinhaEscolhida") || false;
      let premioSelecionado = localStorage.getItem("premioSelecionado") || "";

      if (premioSelecionado) {
        submitButton.disabled = false;
      }

      window.addEventListener("beforeunload", (event) => {
        if (selectedCard && !localStorage.getItem("resultadoEnviado")) {
          event.preventDefault();
          event.returnValue =
            "Voc√™ j√° raspou! Envie o resultado antes de sair.";
        }
      });

      function enviarResultado() {
        if (!premioSelecionado) {
          alert("Voc√™ precisa raspar uma op√ß√£o primeiro!");
        } else {
          const mensagem = encodeURIComponent(
            `üéä Acabei de jogar a Raspadinha Riach√£o e ganhei: ${premioSelecionado}!`
          );
          const numeroWhatsApp = "5584996132907";
          const linkWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${mensagem}`;

          localStorage.setItem("resultadoEnviado", true);
          localStorage.removeItem("raspadinhaEscolhida");
          localStorage.removeItem("premioSelecionado");

          window.open(linkWhatsApp, "_blank");
          location.reload();
        }
      }

      selectedPrizes.forEach((prize) => {
        const card = document.createElement("div");
        card.classList.add("scratch-card");
        
        // Cria a estrutura da carta com overlay e imagem do pr√™mio
        card.innerHTML = `
          <div class="message">
            <img src="${prizeImages[prize]}" alt="${prize}">
            <span>${prize}</span>
          </div>
          <div class="scratch-overlay"></div>
          <canvas></canvas>
          <div class="scratch-text">Raspe aqui para revelar</div>
        `;
        
        scratchContainer.appendChild(card);

        const canvas = card.querySelector("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = card.clientWidth;
        canvas.height = card.clientHeight;
        
        // Preenche o canvas com a cor de raspadinha
        ctx.fillStyle = "#c0c0c0";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Adiciona textura
        ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const radius = Math.random() * 5 + 2;
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
        }

        let isDrawing = false;
        let totalScratched = 0;
        const scratchThreshold = 0.3; // 30% raspado para revelar

        function clearArea(x, y, radius = 25) {
          ctx.globalCompositeOperation = "destination-out";
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
          
          checkScratchedArea();
        }

        function checkScratchedArea() {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const pixels = imageData.data;
          let transparentPixels = 0;
          
          for (let i = 3; i < pixels.length; i += 4) {
            if (pixels[i] === 0) {
              transparentPixels++;
            }
          }
          
          const scratchedRatio = transparentPixels / (canvas.width * canvas.height);
          
          if (scratchedRatio >= scratchThreshold && !premioSelecionado) {
            revealPrize(prize, card);
          }
        }

        function revealPrize(prize, card) {
          premioSelecionado = prize;
          localStorage.setItem("raspadinhaEscolhida", true);
          localStorage.setItem("premioSelecionado", prize);
          
          // Remove o overlay e o texto
          card.querySelector(".scratch-overlay").style.display = "none";
          card.querySelector(".scratch-text").style.display = "none";
          
          // Habilita o bot√£o
          submitButton.disabled = false;
          
          // Mostra mensagem
          alert(`Parab√©ns! Voc√™ ganhou: ${prize}`);
        }

        function getTouchPos(e) {
          const rect = canvas.getBoundingClientRect();
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top,
          };
        }

        function enableScratch() {
          if (premioSelecionado) {
            alert(`Voc√™ j√° raspou e seu pr√™mio foi: ${premioSelecionado}, envie o resultado para reivindicar o seu pr√™mio!`);
            return;
          }

          if (selectedCard) return;
          selectedCard = true;

          // Eventos de mouse
          canvas.addEventListener("mousedown", (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            clearArea(e.clientX - rect.left, e.clientY - rect.top, 25);
          });
          
          canvas.addEventListener("mouseup", () => (isDrawing = false));
          
          canvas.addEventListener("mousemove", (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            clearArea(e.clientX - rect.left, e.clientY - rect.top, 25);
          });

          // Eventos de touch
          canvas.addEventListener("touchstart", (e) => {
            e.preventDefault();
            isDrawing = true;
            const pos = getTouchPos(e);
            clearArea(pos.x, pos.y, 30);
          });
          
          canvas.addEventListener("touchend", () => (isDrawing = false));
          
          canvas.addEventListener("touchmove", (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const pos = getTouchPos(e);
            clearArea(pos.x, pos.y, 30);
          });
        }

        card.addEventListener("click", enableScratch);
      });
    </script>
  </body>
</html>